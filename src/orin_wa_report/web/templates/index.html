<!-- frontend.html -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ORIN WA Report</title>
  <link rel="stylesheet" href="/static/style.css" />

</head>

<body>
  <div class="container">
    <header>
      <h1>ORIN WA Report</h1>
      <p class="muted">Manage development users and WhatsApp alerts.</p>
    </header>

    <section id="settings" class="card">
      <h3>Settings</h3>
      <div class="row">
        <label class="row">Enable Create Dummy Alert <div id="enable_create_dummy_alert" class="toggle">
            <div class="dot"></div>
          </div></label>
        <label class="row">Enable Send Alert <div id="enable_send_alert" class="toggle">
            <div class="dot"></div>
          </div></label>
        <button id="apply_settings">Apply Settings</button>
      </div>
    </section>

    <section id="user-section" class="card">
      <h3>User Section</h3>
      <div style="display:flex;gap:40px;flex-wrap:wrap">
        <div style="flex:1; min-width:300px;">
          <h4>Register New User</h4>
          <form id="createForm">
            <div class="row"><label>Name</label><input id="name" type="text" required /></div>
            <div class="row"><label>Verified</label><input id="verified" type="checkbox" /></div>
            <div class="row"><label>Phone (if verified)</label><input id="wa_number" type="text" placeholder="628..." />
            </div>
            <div class="row"><label>Mimic User</label>
              <select id="mimic_user">
                <option>None</option>
                <option>41481</option>
                <option>41677</option>
                <option>41885</option>
                <option>42079</option>
              </select>
            </div>
            <div class="row"><button type="submit">Create User</button></div>
          </form>
          <div id="createResult" class="small muted"></div>
        </div>

        <div style="flex:2; min-width:600px; overflow-x:auto;">
          <h4>Registered Users</h4>
          <div style="overflow-x:auto;">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>id</th>
                  <th>name</th>
                  <th>email</th>
                  <th>api_token</th>
                  <th>wa_key</th>
                  <th>wa_notif</th>
                  <th>wa_number</th>
                  <th>wa_verified</th>
                  <th>wa_lid</th>
                  <th>actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="wa-subscribe" class="card">
      <h3>WhatsApp Subscribe</h3>
      <div class="row">
        <label>Choose User</label>
        <select id="chooseUser"></select>
        <div id="waActions"></div>
      </div>
      <div id="waResult" class="small muted"></div>
    </section>

    <footer>
      <p class="muted small">Â© 2025 ORIN WA Report. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const API_BASE = ''

    // Utilities for toggles
    function bindToggle(id) {
      const el = document.getElementById(id)
      el.addEventListener('click', () => el.classList.toggle('on'))
    }
    ['enable_create_dummy_alert', 'enable_send_alert'].forEach(bindToggle)

    async function loadSettings() {
      try {
        const res = await fetch(API_BASE + '/settings')
        const s = await res.json()
        // document.getElementById('enable_agent').classList.toggle('on', s.enable_agent)
        document.getElementById('enable_create_dummy_alert').classList.toggle('on', s.enable_create_dummy_alert)
        document.getElementById('enable_send_alert').classList.toggle('on', s.enable_send_alert)
      } catch (e) { console.warn(e) }
    }
    document.getElementById('apply_settings').addEventListener('click', async () => {
      const payload = {
        // enable_agent: document.getElementById('enable_agent').classList.contains('on'),
        enable_create_dummy_alert: document.getElementById('enable_create_dummy_alert').classList.contains('on'),
        enable_send_alert: document.getElementById('enable_send_alert').classList.contains('on'),
      }
      const r = await fetch(API_BASE + '/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
      const j = await r.json()
      alert('Settings applied')
    })

    // Create user form
    document.getElementById('verified').addEventListener('change', (e) => {
      document.getElementById('wa_number').disabled = !e.target.checked
    })

    document.getElementById('createForm').addEventListener('submit', async (ev) => {
      ev.preventDefault()
      const name = document.getElementById('name').value.trim()
      const verified = document.getElementById('verified').checked
      const wa_number = document.getElementById('wa_number').value.trim()
      const mimic_user = document.getElementById('mimic_user').value
      const payload = { name, verified, wa_number: wa_number || null, mimic_user }
      try {
        const res = await fetch(API_BASE + '/alert/users/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        if (res.status === 409) {
          const j = await res.json(); document.getElementById('createResult').innerText = 'Error: mimic_user already taken'
        } else if (!res.ok) {
          const j = await res.json(); document.getElementById('createResult').innerText = 'Error: ' + (j.detail || 'unknown')
        } else {
          document.getElementById('createResult').innerText = 'User created'
          document.getElementById('createForm').reset()
        }
      } catch (err) { document.getElementById('createResult').innerText = 'Network error' }
      await refreshAll()
    })

    // Fetch and render users table
    async function refreshUsers() {
      const res = await fetch(API_BASE + '/alert/users')
      const users = await res.json()
      const tbody = document.querySelector('#usersTable tbody')
      tbody.innerHTML = ''
      const choose = document.getElementById('chooseUser')
      choose.innerHTML = ''
      users.forEach(u => {
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td class="small">${u.api_token}</td>
          <td>${u.wa_key || ''}</td>
          <td>${u.wa_notif}</td>
          <td>${u.wa_number || ''}</td>
          <td>${u.wa_verified}</td>
          <td>${u.wa_lid || ''}</td>
          <td></td>
        `
        // actions column
        const actions = tr.querySelector('td:last-child')
        const del = document.createElement('button'); del.innerText = 'Delete'; del.addEventListener('click', async () => {
          if (!confirm('Delete user?')) return
          await fetch(API_BASE + `/alert/users/${u.id}/delete`, { method: 'POST' })
          await refreshAll()
        })
        actions.appendChild(del)
        tbody.appendChild(tr)

        // add to choose dropdown
        const opt = document.createElement('option'); opt.value = u.id; opt.innerText = `${u.id} - ${u.name}`
        choose.appendChild(opt)
      })
    }

    async function refreshWaActions() {
      const choose = document.getElementById('chooseUser')
      const userId = choose.value
      const container = document.getElementById('waActions')
      container.innerHTML = ''
      if (!userId) return
      const res = await fetch(API_BASE + '/alert/users')
      const users = await res.json()
      const u = users.find(x => String(x.id) === String(userId))
      if (!u) return

      if (Number(u.wa_verified) === 0) {
        const btn = document.createElement('button'); btn.innerText = 'Subscribe to ORIN Alert Notifications'
        btn.addEventListener('click', async () => {
          // request subscribe key
          const r = await fetch(API_BASE + `/alert/users/verify`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${u.api_token}`
            },
            body: JSON.stringify({})
          });
          const j = await r.json()
          if (!j.ok) { alert('Error getting key'); return }
          const key = j.data.key
          // open wa link in new tab
          const waUrl = j.data.wa_url
          window.open(waUrl, '_blank')
          document.getElementById('waResult').innerText = 'Opened WhatsApp link. Waiting for verification...'
        })
        container.appendChild(btn)
      } else {
        // fetch current toggle state from server
        let notifState = false
        try {
          const r = await fetch(API_BASE + `/alert/users/toggle_notification`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${u.api_token}` }
          })
          const j = await r.json()
          notifState = !!j.is_toggle_on  // assuming API returns { toggle: False|True }
        } catch (e) { console.warn('Failed to fetch toggle', e) }

        const toggle = document.createElement('button')
        toggle.innerText = notifState ? 'Disable Notifications' : 'Enable Notifications'
        toggle.addEventListener('click', async () => {
          try {
            // determine the desired new state
            const desiredToggle = notifState ? false : true;

            const r = await fetch(API_BASE + `/alert/users/toggle_notification`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${u.api_token}`
              },
              body: JSON.stringify({ toggle: desiredToggle })
            });

            const j = await r.json()
            notifState = !!j.is_toggle_on
            toggle.innerText = notifState ? 'Disable Notifications' : 'Enable Notifications'
          } catch (e) { alert('Failed to toggle notifications') }
        })
        container.appendChild(toggle)

        const unsub = document.createElement('button');
        unsub.style.marginLeft = '8px';
        unsub.innerText = 'Unsubscribe ORIN Alert Notifications';
        unsub.addEventListener('click', async () => {
          if (!confirm('Unsubscribe and remove verification?')) return;

          try {
            const r = await fetch(API_BASE + `/alert/users/unsubscribe`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${u.api_token}`,
                'Content-Type': 'application/json'
              }
            });

            if (!r.ok) throw new Error('Failed to unsubscribe');

            await refreshAll();
          } catch (e) {
            alert(e.message);
          }
        });
        container.appendChild(unsub);


        const del = document.createElement('button'); del.style.marginLeft = '8px'; del.innerText = 'Delete User'
        del.addEventListener('click', async () => {
          if (!confirm('Delete user?')) return
          await fetch(API_BASE + `/alert/users/${u.id}/delete`, { method: 'POST' })
          await refreshAll()
        })
        container.appendChild(del)
      }
    }

    document.getElementById('chooseUser').addEventListener('change', refreshWaActions)

    async function refreshAll() {
      await refreshUsers()
      await refreshWaActions()
      await loadSettings()
    }

    // initial load
    refreshAll()

    // Periodically refresh to keep UI in sync (optional)
    setInterval(refreshAll, 15000)
  </script>
</body>

</html>